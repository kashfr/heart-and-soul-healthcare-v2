rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function incomingData() {
      return request.resource.data;
    }
    
    // Contact Submissions
    match /contactSubmissions/{submissionId} {
      allow read, update, delete: if false; // Only allow Admin SDK
      allow create: if 
        // Required fields
        incomingData().name is string && incomingData().name.size() > 0 &&
        incomingData().email is string && incomingData().email.size() > 0 &&
        incomingData().subject is string && incomingData().subject.size() > 0 &&
        incomingData().message is string && incomingData().message.size() > 0 &&
        // Status and Timestamp
        incomingData().status == 'new' &&
        incomingData().submittedAt == request.time &&
        // Optional fields checking
        (incomingData().get('phone', '') is string);
    }

    // Referral Submissions
    match /referralSubmissions/{submissionId} {
      allow read, update, delete: if false;
      allow create: if
        // Validate structure exists
        incomingData().client is map &&
        incomingData().program is map &&
        incomingData().referrer is map &&
        incomingData().details is map &&
        
        // Basic Client Info validation
        incomingData().client.firstName is string && incomingData().client.firstName.size() > 0 &&
        incomingData().client.lastName is string && incomingData().client.lastName.size() > 0 &&
        incomingData().client.dob is string &&
        incomingData().client.phone is string &&
        
        // Metadata
        incomingData().status == 'new' &&
        incomingData().submittedAt == request.time;
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
